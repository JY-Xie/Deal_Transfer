//
// Created by XieJiYe on 2024/5/8.
//

#include "read_tran.hpp"
#include "csv.hpp"
#include "make_index.hpp"
#include "my_utils.hpp"

read_tran::read_tran(std::string &file_path, std::vector <std::string> &columns) {
    this->file_path = file_path;
    this->columns = columns;
    this->metro_station_info = {
            {1, {30.690249, 104.11448}},
            {2, {30.642208, 103.956215}},
            {3, {30.676027, 104.030851}},
            {4, {30.735239, 103.977351}},
            {5, {30.817776, 104.092232}},
            {6, {30.793022, 104.086764}},
            {7, {30.697184, 104.063802}},
            {8, {30.671807, 103.944354}},
            {9, {30.671484, 104.026539}},
            {10, {30.698577, 104.028667}},
            {11, {30.708831, 104.010962}},
            {12, {30.452422, 104.09029}},
            {13, {30.649116, 104.178446}},
            {14, {30.631885, 104.137972}},
            {15, {30.686063, 103.974077}},
            {16, {30.599288, 104.168217}},
            {17, {30.819509, 104.1923}},
            {18, {30.627339, 104.144697}},
            {19, {30.625453, 104.004314}},
            {20, {30.557943, 104.005303}},
            {21, {30.627562, 104.07353}},
            {22, {30.655966, 104.076694}},
            {23, {30.613783, 104.005974}},
            {24, {30.609239, 103.988588}},
            {25, {30.667963, 104.13388}},
            {26, {30.773886, 104.062278}},
            {27, {30.624224, 104.13033}},
            {28, {30.595633, 104.198234}},
            {29, {30.552275, 104.04396}},
            {30, {30.440183, 104.031881}},
            {31, {30.636049, 104.109631}},
            {32, {30.622163, 104.095951}},
            {33, {30.622326, 104.085426}},
            {34, {30.670877, 104.126583}},
            {35, {30.650652, 104.084922}},
            {36, {30.663537, 104.00561}},
            {37, {30.574028, 103.923351}},
            {38, {30.716011, 104.100801}},
            {39, {30.724104, 104.055974}},
            {40, {30.77387, 104.072509}},
            {41, {30.501991, 104.033235}},
            {42, {30.683096, 104.123962}},
            {43, {30.628458, 104.049905}},
            {44, {30.676633, 103.92053}},
            {45, {30.679881, 103.887263}},
            {46, {30.689029, 103.841347}},
            {47, {30.577924, 104.061576}},
            {48, {30.716545, 104.057399}},
            {50, {30.679148, 104.039102}},
            {51, {30.697075, 104.10411}},
            {52, {30.618904, 104.031998}},
            {53, {30.642802, 104.039947}},
            {54, {30.596708, 104.061254}},
            {55, {30.533405, 104.095806}},
            {56, {30.687244, 103.858363}},
            {57, {30.513196, 104.073319}},
            {58, {30.480706, 104.067369}},
            {59, {30.421605, 104.074818}},
            {60, {30.494518, 104.068304}},
            {61, {30.441397, 104.086916}},
            {62, {30.593887, 103.934764}},
            {63, {30.803014, 103.885334}},
            {64, {30.771817, 103.935265}},
            {65, {30.637183, 104.027355}},
            {66, {30.467187, 104.070833}},
            {67, {30.673622, 104.088155}},
            {68, {30.60743, 104.154927}},
            {69, {30.738866, 104.002784}},
            {70, {30.685896, 104.045794}},
            {71, {30.444535, 103.854991}},
            {72, {30.487816, 103.879539}},
            {73, {30.699039, 104.038369}},
            {74, {30.52869, 104.067281}},
            {75, {30.827668, 104.096609}},
            {76, {30.645543, 104.063807}},
            {77, {30.600962, 103.998968}},
            {78, {30.506008, 104.067984}},
            {79, {30.651258, 104.137032}},
            {80, {30.754283, 104.057654}},
            {81, {30.723544, 103.813064}},
            {82, {30.52251, 103.890704}},
            {83, {30.700181, 103.970501}},
            {84, {30.44897, 104.011294}},
            {85, {30.614167, 104.149837}},
            {86, {30.698293, 104.071276}},
            {87, {30.60805, 104.064953}},
            {88, {30.647834, 103.976659}},
            {89, {30.673411, 104.096255}},
            {90, {30.584035, 104.04774}},
            {91, {30.585177, 104.222802}},
            {92, {30.713739, 104.034772}},
            {93, {30.594488, 103.968143}},
            {94, {30.772427, 104.1225}},
            {95, {30.723227, 104.004569}},
            {96, {30.585065, 104.061522}},
            {97, {30.581557, 104.082234}},
            {98, {30.679936, 104.010226}},
            {99, {30.593013, 104.086768}},
            {100, {30.756522, 103.794454}},
            {101, {30.724299, 103.99433}},
            {102, {30.57679, 104.048023}},
            {103, {30.570073, 104.064131}},
            {104, {30.570937, 104.067516}},
            {105, {30.56633, 104.043855}},
            {106, {30.65208, 104.063566}},
            {107, {30.799517, 104.150639}},
            {108, {30.514748, 104.037225}},
            {109, {30.62503, 104.102296}},
            {110, {30.773769, 104.080231}},
            {111, {30.637522, 103.918381}},
            {112, {30.697053, 104.05475}},
            {113, {30.624345, 104.035323}},
            {114, {30.746864, 104.111524}},
            {115, {30.39411, 104.069818}},
            {116, {30.630527, 104.035951}},
            {117, {30.667773, 104.047834}},
            {118, {30.649403, 104.161745}},
            {119, {30.448555, 103.993804}},
            {120, {30.691818, 104.092056}},
            {121, {30.674745, 104.134498}},
            {122, {30.590247, 104.210566}},
            {123, {30.548998, 103.977248}},
            {124, {30.68464, 104.080894}},
            {125, {30.811102, 104.089274}},
            {126, {30.418204, 103.789958}},
            {127, {30.610077, 104.096604}},
            {128, {30.602781, 104.09545}},
            {129, {30.513505, 104.099538}},
            {130, {30.460297, 104.017641}},
            {131, {30.575476, 104.256179}},
            {132, {30.606926, 103.941354}},
            {133, {30.562792, 104.266244}},
            {134, {30.653802, 104.006269}},
            {135, {30.744481, 104.056983}},
            {136, {30.542057, 104.095806}},
            {137, {30.457153, 104.071168}},
            {138, {30.48525, 104.101364}},
            {139, {30.669357, 104.063038}},
            {140, {30.680234, 103.911454}},
            {141, {30.815512, 104.162168}},
            {142, {30.787288, 103.912376}},
            {143, {30.542705, 104.043899}},
            {144, {30.660672, 103.867193}},
            {145, {30.650827, 104.193374}},
            {146, {30.639426, 104.073497}},
            {147, {30.49126, 104.030792}},
            {148, {30.692228, 103.849811}},
            {149, {30.627316, 104.064388}},
            {150, {30.640142, 104.105337}},
            {151, {30.648057, 104.090903}},
            {152, {30.663416, 103.975269}},
            {153, {30.798769, 103.892624}},
            {154, {30.50499, 104.096326}},
            {155, {30.52784, 104.041781}},
            {156, {30.680864, 104.089267}},
            {157, {30.426942, 104.059715}},
            {158, {30.727689, 104.023808}},
            {159, {30.662101, 104.038455}},
            {160, {30.679007, 103.996606}},
            {161, {30.600703, 104.031638}},
            {162, {30.732834, 104.056024}},
            {163, {30.688317, 104.070783}},
            {164, {30.661718, 104.054261}},
            {165, {30.419238, 103.801052}},
            {166, {30.703382, 104.064038}},
            {167, {30.318933, 104.313839}},
            {168, {30.631953, 104.092362}},
            {169, {30.787296, 104.136093}},
            {170, {30.556411, 103.912585}},
            {171, {30.606565, 104.075645}},
            {172, {30.583985, 104.024285}},
            {173, {30.691473, 104.048794}},
            {174, {30.66652, 104.116674}},
            {175, {30.78004, 103.921306}},
            {176, {30.611327, 104.046492}},
            {177, {30.470483, 104.099606}},
            {178, {30.707001, 104.081129}},
            {179, {30.654163, 104.03871}},
            {180, {30.635954, 104.064124}},
            {181, {30.6188, 104.121896}},
            {182, {30.681822, 104.141356}},
            {183, {30.64836, 104.169766}},
            {184, {30.762436, 104.057453}},
            {185, {30.588714, 104.02952}},
            {186, {30.597859, 104.048374}},
            {187, {30.82123, 104.183907}},
            {188, {30.556976, 104.06642}},
            {189, {30.663195, 104.081402}},
            {190, {30.700192, 103.829401}},
            {191, {30.592369, 104.04815}},
            {192, {30.578308, 104.239815}},
            {193, {30.68519, 104.027197}},
            {194, {30.79354, 103.901724}},
            {195, {30.660044, 104.134591}},
            {196, {30.618628, 103.966862}},
            {197, {30.567154, 103.918187}},
            {198, {30.581032, 103.957859}},
            {199, {30.572243, 103.954654}},
            {200, {30.546183, 103.914163}},
            {201, {30.648817, 104.11185}},
            {202, {30.579821, 104.009659}},
            {203, {30.637986, 104.090403}},
            {204, {30.612208, 104.113536}},
            {205, {30.519016, 104.067531}},
            {206, {30.698051, 104.090739}},
            {207, {30.429873, 104.044659}},
            {208, {30.631977, 104.121016}},
            {209, {30.595111, 104.011443}},
            {210, {30.627776, 104.019048}},
            {211, {30.667027, 104.074682}},
            {212, {30.435544, 104.075357}},
            {213, {30.659562, 104.063385}},
            {214, {30.319686, 104.441712}},
            {215, {30.548906, 104.066619}},
            {216, {30.432577, 104.083907}},
            {217, {30.539507, 104.066865}},
            {219, {30.748377, 103.973843}},
            {219, {30.748429, 103.974247}},
            {220, {30.756773, 103.952446}},
            {221, {30.664374, 104.046337}},
            {222, {30.617721, 104.064597}},
            {223, {30.806593, 104.156102}},
            {224, {30.498485, 104.097372}},
            {225, {30.64644, 104.117152}},
            {226, {30.657376, 104.112491}},
            {227, {30.67813, 103.816823}},
            {228, {30.809733, 103.876136}},
            {229, {30.719165, 104.084775}},
            {230, {30.675463, 103.853273}},
            {231, {30.674732, 104.007489}},
            {232, {30.674843, 104.065545}},
            {233, {30.55304, 103.988478}},
            {234, {30.504193, 104.078903}},
            {235, {30.427727, 103.81563}},
            {236, {30.7101, 104.06192}},
            {237, {30.445445, 104.071263}},
            {238, {30.639785, 104.010448}},
            {239, {30.629573, 103.991248}},
            {240, {30.625622, 103.982773}},
            {241, {30.688277, 104.056518}},
            {242, {30.427429, 104.075003}},
            {243, {30.64975, 104.219582}},
            {244, {30.720987, 104.029093}},
            {245, {30.672967, 104.017943}},
            {246, {30.696914, 104.047321}},
            {247, {30.760864, 103.969266}},
            {248, {30.578358, 104.070602}},
            {249, {30.518769, 104.09726}},
            {250, {30.664357, 104.099845}},
            {251, {30.465934, 103.871112}},
            {252, {30.646675, 104.072629}},
            {253, {30.413588, 103.781194}},
            {254, {30.524703, 104.095822}},
            {256, {30.414659, 104.098969}},
            {257, {30.407889, 104.073897}},
            {258, {30.733295, 104.01923}},
            {259, {30.761204, 103.981129}},
            {255, {30.704894, 104.041479}},
            {260, {30.778923, 104.086233}},
            {261, {30.727669, 104.105796}},
            {262, {30.696578, 104.01049}},
            {263, {30.683795, 103.829249}},
            {264, {30.690948, 104.018339}},
            {265, {30.636946, 104.049835}},
            {266, {30.473506, 104.025281}},
            {267, {30.608915, 104.031883}},
            {268, {30.54017, 103.900502}},
            {269, {30.715686, 104.011114}},
            {270, {30.583453, 103.932967}},
            {271, {30.641523, 104.137133}},
            {272, {30.630517, 104.045242}},
            {273, {30.681355, 103.870804}},
            {274, {30.656273, 104.095953}},
            {275, {30.552556, 104.095862}},
            {276, {30.705629, 104.094661}},
            {277, {30.766166, 104.118615}},
            {278, {30.676203, 103.962039}},
            {279, {30.560909, 104.09358}},
            {280, {30.668742, 104.038206}},
            {281, {30.823369, 104.173226}},
            {282, {30.568985, 104.005742}},
            {283, {30.750172, 103.991351}}
    };
}

int read_tran::transfer_details_statistics(
        std::vector<Make_bus_idx::Busrawdata> &bus_data,
        std::vector<Make_metro_idx::Metrorawdata> &metro_data
        )
    {
    csv::CSVReader reader(this->file_path);

    std::string bus_cardno;
    std::string metro_cardno;
    unsigned int bus_idx;
    unsigned int metro_idx;

    double distance;
    double time_span;

    std::ofstream ofs("example.csv");
    auto writer = csv::make_csv_writer(ofs);
    writer << std::make_tuple("station", "distance", "time_span", "speed");

    for (auto &row: reader) {
        bus_cardno = row[this->columns[0]].get<std::string>();
        bus_idx = row[this->columns[1]].get<unsigned int>();
        metro_cardno = row[this->columns[2]].get<std::string>();
        metro_idx = row[this->columns[3]].get<unsigned int>();

        /*
         * 需要的指标
         * 每个用户的该次访问的站
         * 每次可能的匹配时间间隔
         * 每次可能的匹配换成距离
         */
        int temp_stop = metro_data[metro_idx].deststop;
        distance = My_utils::haversineDistance(
                bus_data[bus_idx].latitude,
                bus_data[bus_idx].longitude,
                this->metro_station_info[temp_stop][0],
                this->metro_station_info[temp_stop][1]
                );
        time_span = My_utils::calc_time_span(metro_data[metro_idx].destdate, bus_data[bus_idx].consumedate);

        double speed = distance / time_span;
        writer << std::make_tuple(temp_stop, distance, time_span, speed);

    }
    ofs.close();
    return 0;
}
